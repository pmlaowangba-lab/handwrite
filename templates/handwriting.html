<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å†™ä½“ç”Ÿæˆå™¨ - Handwriting Generator</title>

    <!-- æœ¬åœ°æ‰‹å†™å­—ä½“ -->
    <style>
        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“1-åœ†æ¶¦';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”1ï¼šåœ“æ½¤.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“2-ç§€æ°”';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”2ï¼šç§€æ°£.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“3-å‘†èŒ';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”3ï¼šå‘†èŒ.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“4-POP';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”4ï¼šPOP.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“5-è¡Œæ¥·';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”5ï¼šè¡Œæ¥·.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“6-QèŒ';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”6ï¼šQèŒ.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“7-é£˜é€¸';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”7ï¼šé£„é€¸.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ¸…æ¾æ‰‹å†™ä½“8-éšæ€§';
            src: url('../assets/fonts/æ¸…æ¾æ‰‹å¯«é«”8ï¼šéš¨æ€§.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ²ç‘¶è½¯ç¬”æ‰‹å†™ä½“';
            src: url('../assets/fonts/æ²ç‘¶è½¯ç¬”æ‰‹å†™ä½“.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ²ç‘¶éšå¿ƒæ‰‹å†™ä½“';
            src: url('../assets/fonts/æ²ç‘¶éšå¿ƒæ‰‹å†™ä½“.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'å†…æµ·å­—ä½“';
            src: url('../assets/fonts/å…§æµ·å­—é«”-Regular-Lite.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'å¥¹å±¿å±±æµ·';
            src: url('../assets/fonts/å¥¹å±¿å±±æµ·.ttf') format('truetype');
            font-display: swap;
        }

        @font-face {
            font-family: 'æ —å£³åšåšä½“';
            src: url('../assets/fonts/æ —å£³åšåšä½“.ttf') format('truetype');
            font-display: swap;
        }
    </style>

    <style>
        :root {
            --bg-main: #f3f7ff;
            --bg-accent: #f8faff;
            --surface: rgba(255, 255, 255, 0.88);
            --surface-strong: rgba(255, 255, 255, 0.96);
            --text-1: #111827;
            --text-2: #475569;
            --text-3: #64748b;
            --border: rgba(148, 163, 184, 0.28);
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --purple: #7c3aed;
            --green: #10b981;
            --card-shadow: 0 12px 40px rgba(37, 99, 235, 0.12);
            --focus: 0 0 0 3px rgba(37, 99, 235, 0.18);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background:
                radial-gradient(1200px 450px at 10% -20%, #dbeafe 0%, transparent 70%),
                radial-gradient(900px 400px at 90% -10%, #ede9fe 0%, transparent 68%),
                linear-gradient(180deg, var(--bg-main), var(--bg-accent));
            min-height: 100vh;
            overflow: hidden;
            color: var(--text-1);
        }

        .container {
            display: flex;
            gap: 16px;
            height: 100vh;
            padding: 16px;
        }

        .left-panel {
            width: 390px;
            min-width: 320px;
            max-width: 430px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(8px);
        }

        .left-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-thumb {
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.45);
        }

        .panel-header {
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 18px;
            background: linear-gradient(120deg, rgba(37, 99, 235, 0.11), rgba(124, 58, 237, 0.09));
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .left-panel h1 {
            font-size: 24px;
            line-height: 1.2;
            margin-bottom: 8px;
            color: #0f172a;
            letter-spacing: 0.2px;
        }

        .left-panel p {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-2);
        }

        .section-title {
            display: flex;
            align-items: center;
            margin: 10px 0 14px;
            color: #334155;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .section-title::before {
            content: '';
            width: 14px;
            height: 2px;
            border-radius: 999px;
            margin-right: 8px;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 8px;
        }

        .form-group textarea,
        .form-group select,
        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 12px;
            padding: 11px 12px;
            font-size: 14px;
            color: #0f172a;
            background: rgba(255, 255, 255, 0.95);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            line-height: 1.55;
        }

        .form-group textarea:focus,
        .form-group select:focus,
        .form-group input[type="text"]:focus,
        .form-group input[type="password"]:focus {
            outline: none;
            background: #fff;
            border-color: rgba(37, 99, 235, 0.5);
            box-shadow: var(--focus);
        }

        .input-hint {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-3);
            line-height: 1.45;
        }

        .slider-group {
            margin-bottom: 14px;
            border: 1px solid rgba(203, 213, 225, 0.65);
            border-radius: 14px;
            padding: 12px 12px 11px;
            background: rgba(255, 255, 255, 0.85);
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-label span {
            font-size: 13px;
            font-weight: 700;
            color: #334155;
        }

        .slider-value {
            font-size: 13px;
            color: var(--primary);
            font-weight: 800;
        }

        .range-hint {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 11px;
            color: #94a3b8;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(90deg, #bfdbfe 0%, #dbeafe 100%);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #60a5fa);
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.35);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #60a5fa);
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.35);
            cursor: pointer;
        }

        .btn {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            color: #fff;
            transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            filter: brightness(1.02);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.26);
            margin-bottom: 10px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--green), #059669);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.25);
        }

        .btn-ai {
            margin-top: 10px;
            background: linear-gradient(135deg, var(--purple), #6d28d9);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.24);
        }

        .btn-ai:disabled {
            background: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .ai-config-section {
            margin-bottom: 18px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 14px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.9);
        }

        .ai-config-header {
            background: linear-gradient(90deg, rgba(248, 250, 252, 0.9), rgba(239, 246, 255, 0.95));
            padding: 13px 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .ai-config-header:hover {
            background: linear-gradient(90deg, rgba(239, 246, 255, 0.92), rgba(224, 242, 254, 0.96));
        }

        .ai-config-header h3 {
            font-size: 13px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .ai-config-toggle {
            font-size: 12px;
            color: #64748b;
        }

        .ai-config-body {
            padding: 14px;
            display: none;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .ai-config-body.active {
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-group .btn {
            flex: 1;
            padding: 9px;
            font-size: 12px;
        }

        .status-message {
            margin-top: 10px;
            padding: 9px 11px;
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid transparent;
            display: none;
        }

        .status-message.success {
            background: #ecfdf5;
            color: #065f46;
            border-color: #6ee7b7;
            display: block;
        }

        .status-message.error {
            background: #fef2f2;
            color: #991b1b;
            border-color: #fca5a5;
            display: block;
        }

        .action-buttons {
            margin-top: 8px;
        }

        .right-preview {
            flex: 1;
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        .preview-shell {
            width: 100%;
            background: var(--surface-strong);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .preview-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 18px;
            background: linear-gradient(90deg, rgba(248, 250, 252, 0.95), rgba(239, 246, 255, 0.95));
            border-bottom: 1px solid rgba(148, 163, 184, 0.26);
        }

        .preview-eyebrow {
            margin: 0;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }

        .preview-title {
            margin: 2px 0 0;
            font-size: 18px;
            color: #0f172a;
        }

        .preview-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .meta-chip {
            font-size: 12px;
            line-height: 1;
            padding: 8px 10px;
            border-radius: 999px;
            color: #1e3a8a;
            background: rgba(37, 99, 235, 0.08);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        #canvas-container {
            margin: 18px;
            background: #fff;
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.24);
            box-shadow: 0 6px 22px rgba(15, 23, 42, 0.08);
            overflow: auto;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        @media (max-width: 1180px) {
            body {
                overflow: auto;
            }

            .container {
                height: auto;
                min-height: 100vh;
                flex-direction: column;
                padding: 12px;
            }

            .left-panel {
                width: 100%;
                min-width: 0;
                max-width: none;
            }

            .preview-toolbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .preview-meta {
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- å·¦ä¾§å‚æ•°é¢æ¿ -->
        <div class="left-panel">
            <div class="panel-header">
                <h1>âœï¸ æ‰‹å†™ä½“ç”Ÿæˆå™¨</h1>
                <p>è¾“å…¥æ–‡æœ¬ï¼Œå®æ—¶ç”Ÿæˆæ‰‹å†™æ•ˆæœï¼Œé€‚åˆå½•å±ã€æ•™å­¦ä¸å†…å®¹åˆ›ä½œã€‚</p>
            </div>

            <div class="section-title">AI è¾…åŠ©</div>
            <div class="section-title">æ–‡æœ¬å†…å®¹</div>
            <div class="form-group">
                <label for="text-input">ğŸ“ è¾“å…¥æ–‡æœ¬</label>
                <textarea id="text-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³è¦è½¬æ¢çš„æ–‡å­—...">è¿™æ˜¯ä¸€æ®µæ‰‹å†™ä½“æµ‹è¯•æ–‡å­—ã€‚
ä½ å¯ä»¥è¾“å…¥ä»»ä½•å†…å®¹ï¼Œ
ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæ‰‹å†™æ•ˆæœã€‚

é€‚åˆç”¨äºè§†é¢‘å½•åˆ¶ã€
ç¬”è®°å±•ç¤ºç­‰åœºæ™¯ã€‚</textarea>
                <button class="btn btn-ai ai-polish-btn" onclick="aiPolish()" id="ai-polish-btn">
                    ğŸ¤– AI æ¶¦è‰²æ–‡æ¡ˆ
                </button>
            </div>

            <div class="section-title">è§†è§‰å‚æ•°</div>
            <div class="form-group">
                <label for="font-select">ğŸ¨ é€‰æ‹©å­—ä½“</label>
                <select id="font-select">
                    <option value="æ¸…æ¾æ‰‹å†™ä½“1-åœ†æ¶¦">æ¸…æ¾æ‰‹å†™ä½“1-åœ†æ¶¦</option>
                    <option value="æ¸…æ¾æ‰‹å†™ä½“2-ç§€æ°”">æ¸…æ¾æ‰‹å†™ä½“2-ç§€æ°”</option>
                    <option value="æ¸…æ¾æ‰‹å†™ä½“3-å‘†èŒ">æ¸…æ¾æ‰‹å†™ä½“3-å‘†èŒ</option>
                    <option value="æ¸…æ¾æ‰‹å†™ä½“4-POP">æ¸…æ¾æ‰‹å†™ä½“4-POP</option>
                    <option value="æ¸…æ¾æ‰‹å†™ä½“5-è¡Œæ¥·" selected>æ¸…æ¾æ‰‹å†™ä½“5-è¡Œæ¥·</option>
                    <option value="æ¸…æ¾æ‰‹å†™ä½“6-QèŒ">æ¸…æ¾æ‰‹å†™ä½“6-QèŒ</option>
                    <option value="æ¸…æ¾æ‰‹å†™ä½“7-é£˜é€¸">æ¸…æ¾æ‰‹å†™ä½“7-é£˜é€¸</option>
                    <option value="æ¸…æ¾æ‰‹å†™ä½“8-éšæ€§">æ¸…æ¾æ‰‹å†™ä½“8-éšæ€§</option>
                    <option value="æ²ç‘¶è½¯ç¬”æ‰‹å†™ä½“">æ²ç‘¶è½¯ç¬”æ‰‹å†™ä½“</option>
                    <option value="æ²ç‘¶éšå¿ƒæ‰‹å†™ä½“">æ²ç‘¶éšå¿ƒæ‰‹å†™ä½“</option>
                    <option value="å†…æµ·å­—ä½“">å†…æµ·å­—ä½“</option>
                    <option value="å¥¹å±¿å±±æµ·">å¥¹å±¿å±±æµ·</option>
                    <option value="æ —å£³åšåšä½“">æ —å£³åšåšä½“</option>
                </select>
            </div>

            <div class="form-group">
                <label for="paper-select">ğŸ“„ çº¸å¼ å°ºå¯¸</label>
                <select id="paper-select">
                    <option value="a4-portrait" selected>A4çº¸-çºµå‘ (4960x7015)</option>
                    <option value="a4-landscape">A4çº¸-æ¨ªå‘ (7015x4960)</option>
                    <option value="b5-portrait">B5çº¸-çºµå‘ (4157x5905)</option>
                    <option value="b5-landscape">B5çº¸-æ¨ªå‘ (5905x4157)</option>
                    <option value="a3-portrait">A3çº¸-çºµå‘ (7015x9921)</option>
                    <option value="a3-landscape">A3çº¸-æ¨ªå‘ (9921x7015)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="paper-bg-select">ğŸ¨ çº¸å¼ èƒŒæ™¯</label>
                <select id="paper-bg-select">
                    <optgroup label="çº¯è‰²èƒŒæ™¯">
                        <option value="white" selected>çº¯ç™½è‰²</option>
                        <option value="cream">#FFF8DC ç±³é»„è‰²</option>
                        <option value="lightgray">#F5F5F5 æµ…ç°è‰²</option>
                    </optgroup>
                    <optgroup label="çœŸå®çº¸å¼ ">
                        <option value="real-grid-white">æ–¹æ ¼çº¸-ç™½è‰²</option>
                        <option value="real-blank-white">ç©ºç™½çº¸-ç™½è‰²</option>
                        <option value="real-lined-cream">æ¨ªçº¿çº¸-ç±³é»„</option>
                        <option value="real-lined-vintage">æ¨ªçº¿çº¸-å¤å¤</option>
                        <option value="real-blank-used">ä½¿ç”¨ç—•è¿¹çº¸</option>
                    </optgroup>
                </select>
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>ğŸ“ æ–‡å­—ä½ç½®å‡Œä¹±åº¦</span>
                    <span class="slider-value" id="position-value">10%</span>
                </div>
                <input type="range" id="position-slider" min="0" max="100" value="10">
                <div class="range-hint">
                    <span>æ•´é½æ’åˆ—</span>
                    <span>å‡Œä¹±ä¸å ª</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>ğŸ“ å­—å·å¤§å°</span>
                    <span class="slider-value" id="fontsize-value">24px</span>
                </div>
                <input type="range" id="fontsize-slider" min="16" max="48" value="24">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>ğŸ“Š è¡Œé—´è·</span>
                    <span class="slider-value" id="lineheight-value">1.8</span>
                </div>
                <input type="range" id="lineheight-slider" min="1.2" max="3.0" step="0.1" value="1.8">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>âœï¸ éšæœºæ¶‚æ”¹æ¦‚ç‡</span>
                    <span class="slider-value" id="scratch-value">3%</span>
                </div>
                <input type="range" id="scratch-slider" min="0" max="100" value="3">
                <div class="range-hint">
                    <span>å®Œç¾æ— ç‘•</span>
                    <span>æ¶‚æ”¹è¿ç¯‡</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>ğŸ–Šï¸ å­—ä½“ç¬”ç”»å‡Œä¹±åº¦</span>
                    <span class="slider-value" id="weight-value">5%</span>
                </div>
                <input type="range" id="weight-slider" min="0" max="100" value="5">
                <div class="range-hint">
                    <span>å·¥æ•´æ¸…æ™°</span>
                    <span>æ­ªä¸ƒæ‰­å…«</span>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="renderHandwriting()">ğŸ”„ åˆ·æ–°é¢„è§ˆ</button>
                <button class="btn btn-secondary" onclick="downloadImage()">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
            </div>
        </div>

        <div class="right-preview">
            <div class="preview-shell">
                <div class="preview-toolbar">
                    <div>
                        <p class="preview-eyebrow">Live Preview</p>
                        <h2 class="preview-title">æ‰‹å†™ç”»å¸ƒ</h2>
                    </div>
                    <div class="preview-meta">
                        <span class="meta-chip" id="meta-paper">A4çº¸-çºµå‘</span>
                        <span class="meta-chip" id="meta-font">æ¸…æ¾æ‰‹å†™ä½“5-è¡Œæ¥·</span>
                        <span class="meta-chip" id="meta-size">24px</span>
                    </div>
                </div>
                <div id="canvas-container">
                    <canvas id="handwriting-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== AI åŠŸèƒ½æ¨¡å— ====================

        // AI Prompt æ¨¡æ¿
        const AI_PROMPT_TEMPLATE = `ä½ æ˜¯ä¸“ä¸šçš„å­¦æœ¯ç¬”è®°æ¶¦è‰²åŠ©æ‰‹ã€‚

æ ¸å¿ƒè§„åˆ™ï¼š
1. ä¸¥ç¦ä½¿ç”¨ä»»ä½• Emoji è¡¨æƒ…
2. ä½¿ç”¨ç®€æ´ã€é«˜å¯†åº¦çš„ä¸“ä¸šè¯­è¨€ï¼Œé¿å…å£è¯­åŒ–
3. æ·±åº¦æ‰©å±•å†…å®¹ï¼š
   - æ¯ä¸ªæ¦‚å¿µè‡³å°‘æ‰©å±• 2-3 ä¸ªæ”¯æ’‘ç‚¹
   - å…³é”®åè¯å¿…é¡»è¡¥å……å®šä¹‰æˆ–è§£é‡Š
   - å¤šå±‚çº§å±•å¼€ï¼ˆæ ‡é¢˜â†’è¦ç‚¹â†’è¯¦ç»†è¯´æ˜ï¼‰
4. è¾“å‡ºæ ¼å¼ï¼š
   # ä¸»æ ‡é¢˜ï¼ˆH0ï¼‰
   ## ç« èŠ‚æ ‡é¢˜ï¼ˆH1ï¼‰
   ### å°èŠ‚æ ‡é¢˜ï¼ˆH2ï¼‰
   æ­£æ–‡å†…å®¹...
   æ³¨ï¼šè¡¥å……è¯´æ˜ï¼ˆNoteï¼‰

è¾“å‡ºè¦æ±‚ï¼š
- å†…å®¹é‡ï¼šè‡³å°‘ 500 å­—ï¼Œç¡®ä¿å……å®
- å±‚çº§æ¸…æ™°ï¼Œé€‚åˆæ‰‹å†™å±•ç¤ºï¼Œä¸è¦æœ‰è¿‡å¤šç©ºç™½å†…å®¹
- ä¿æŒä¸¥è‚ƒã€ä¸“ä¸šçš„å­¦æœ¯é£æ ¼

è¯·å¯¹ç”¨æˆ·è¾“å…¥çš„æ–‡æ¡ˆè¿›è¡Œæ¶¦è‰²å’Œæ‰©å±•ã€‚`;

        // æœ¬åœ°ä»£ç†åœ°å€
        const PROXY_URL = '/api/chat';

        // AI æ¶¦è‰²åŠŸèƒ½ï¼ˆè°ƒç”¨åç«¯æ¥å£ï¼‰
        async function aiPolish() {
            const userInput = textInput.value.trim();
            if (!userInput) {
                alert('è¯·å…ˆè¾“å…¥æ–‡æœ¬');
                return;
            }

            const btn = document.getElementById('ai-polish-btn');
            btn.disabled = true;
            btn.textContent = 'ğŸ¤– AI æ¶¦è‰²ä¸­...';

            try {
                const response = await fetch('/api/polish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: userInput
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'AI æ¶¦è‰²å¤±è´¥');
                }

                textInput.value = result.polished_text;
                alert('æ¶¦è‰²å®Œæˆï¼');

                // è‡ªåŠ¨åˆ·æ–°é¢„è§ˆ
                renderHandwriting();
            } catch (error) {
                alert('æ¶¦è‰²å¤±è´¥ï¼š' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¤– AI æ¶¦è‰²æ–‡æ¡ˆ';
            }
        }

        // ==================== åŸæœ‰åŠŸèƒ½æ¨¡å— ====================

        // è·å– DOM å…ƒç´ 
        const canvas = document.getElementById('handwriting-canvas');
        const ctx = canvas.getContext('2d');
        const textInput = document.getElementById('text-input');
        const fontSelect = document.getElementById('font-select');
        const paperSelect = document.getElementById('paper-select');
        const paperBgSelect = document.getElementById('paper-bg-select');
        const positionSlider = document.getElementById('position-slider');
        const fontsizeSlider = document.getElementById('fontsize-slider');
        const lineheightSlider = document.getElementById('lineheight-slider');
        const scratchSlider = document.getElementById('scratch-slider');
        const weightSlider = document.getElementById('weight-slider');
        const metaPaper = document.getElementById('meta-paper');
        const metaFont = document.getElementById('meta-font');
        const metaSize = document.getElementById('meta-size');

        // çº¸å¼ å°ºå¯¸é…ç½®ï¼ˆ600dpi å®é™…åƒç´ ï¼‰
        const paperSizes = {
            'a4-portrait': { w: 4960, h: 7015 },
            'a4-landscape': { w: 7015, h: 4960 },
            'b5-portrait': { w: 4157, h: 5905 },
            'b5-landscape': { w: 5905, h: 4157 },
            'a3-portrait': { w: 7015, h: 9921 },
            'a3-landscape': { w: 9921, h: 7015 }
        };

        // çº¸å¼ èƒŒæ™¯é…ç½®
        const paperBackgrounds = {
            'white': { type: 'color', value: '#ffffff' },
            'cream': { type: 'color', value: '#FFF8DC' },
            'lightgray': { type: 'color', value: '#F5F5F5' },
            'real-grid-white': { type: 'image', src: '../assets/papers/processed/grid-white-clean.jpg' },
            'real-blank-white': { type: 'image', src: '../assets/papers/processed/blank-white.jpg' },
            'real-lined-cream': { type: 'image', src: '../assets/papers/processed/lined-cream-new.jpg' },
            'real-lined-vintage': { type: 'image', src: '../assets/papers/processed/lined-yellow-vintage.jpg' },
            'real-blank-used': { type: 'image', src: '../assets/papers/processed/blank-used-marks.jpg' }
        };

        // é¢„åŠ è½½çš„èƒŒæ™¯å›¾ç‰‡ç¼“å­˜
        const bgImageCache = {};

        const PREVIEW_BASE_WIDTH = 700;
        const REAL_PAPER_BASE_LINEHEIGHT = 1.8;

        // çœŸå®çº¸å¼ ç‰ˆå¼é…ç½®ï¼ˆæŒ‰åŸå›¾æ¯”ä¾‹ï¼‰
        const realPaperLayouts = {
            'real-grid-white': {
                leftRatio: 0.08,
                rightRatio: 0.08,
                topLineRatio: 0.045,
                topRatio: 0.075,
                bottomRatio: 0.065,
                lineStepRatio: 48 / 1986
            },
            'real-lined-cream': {
                leftRatio: 0.09,
                rightRatio: 0.14,
                topLineRatio: 0.068,
                topRatio: 0.09,
                bottomRatio: 0.09,
                lineStepRatio: 66 / 1796
            },
            'real-lined-vintage': {
                leftRatio: 0.085,
                rightRatio: 0.085,
                topLineRatio: 0.073,
                topRatio: 0.10,
                bottomRatio: 0.10,
                lineStepRatio: 70 / 1932
            },
            'real-blank-white': {
                leftRatio: 0.08,
                rightRatio: 0.08,
                topRatio: 0.09,
                bottomRatio: 0.085
            },
            'real-blank-used': {
                leftRatio: 0.08,
                rightRatio: 0.08,
                topRatio: 0.09,
                bottomRatio: 0.09
            }
        };

        function getBackgroundDrawRect(targetWidth, targetHeight, imageWidth, imageHeight) {
            if (!imageWidth || !imageHeight) {
                return { x: 0, y: 0, w: targetWidth, h: targetHeight };
            }

            const scale = Math.min(targetWidth / imageWidth, targetHeight / imageHeight);
            const drawWidth = imageWidth * scale;
            const drawHeight = imageHeight * scale;

            return {
                x: (targetWidth - drawWidth) / 2,
                y: (targetHeight - drawHeight) / 2,
                w: drawWidth,
                h: drawHeight
            };
        }

        function drawPaperBackground(drawCtx, bgKey, targetWidth, targetHeight, bgImage) {
            const bgConfig = paperBackgrounds[bgKey] || paperBackgrounds.white;
            let drawRect = { x: 0, y: 0, w: targetWidth, h: targetHeight };

            if (bgConfig.type === 'color') {
                drawCtx.fillStyle = bgConfig.value;
                drawCtx.fillRect(0, 0, targetWidth, targetHeight);
                return drawRect;
            }

            // å›¾ç‰‡èƒŒæ™¯ç»Ÿä¸€ä½¿ç”¨ç­‰æ¯”ç¼©æ”¾ï¼Œé¿å…æ‹‰ä¼¸å¯¼è‡´é”™è¡Œ
            drawCtx.fillStyle = '#ffffff';
            drawCtx.fillRect(0, 0, targetWidth, targetHeight);

            if (bgImage) {
                drawRect = getBackgroundDrawRect(targetWidth, targetHeight, bgImage.width, bgImage.height);
                drawCtx.drawImage(bgImage, drawRect.x, drawRect.y, drawRect.w, drawRect.h);
            }

            return drawRect;
        }

        function getTextAscent(drawCtx, fontSize) {
            const metrics = drawCtx.measureText('æµ‹Ag');
            if (metrics && Number.isFinite(metrics.actualBoundingBoxAscent) && metrics.actualBoundingBoxAscent > 0) {
                return metrics.actualBoundingBoxAscent;
            }
            return fontSize * 0.78;
        }

        function getPaperTextLayout({
            drawCtx,
            paperBg,
            targetWidth,
            targetHeight,
            drawRect,
            fontSize,
            lineHeight
        }) {
            const basePadding = 60 * (targetWidth / PREVIEW_BASE_WIDTH);
            const config = realPaperLayouts[paperBg];
            const hasRealPaperConfig = Boolean(config);

            if (!hasRealPaperConfig) {
                return {
                    left: basePadding,
                    right: targetWidth - basePadding,
                    top: basePadding,
                    bottom: targetHeight - basePadding,
                    rowAdvance: fontSize * lineHeight,
                    lineSnapped: false,
                    naturalLineStep: null
                };
            }

            const leftPadding = Math.max(basePadding * 0.65, drawRect.w * config.leftRatio);
            const rightPadding = Math.max(basePadding * 0.65, drawRect.w * config.rightRatio);
            const bottomPadding = Math.max(basePadding * 0.5, drawRect.h * config.bottomRatio);

            const left = drawRect.x + leftPadding;
            const right = drawRect.x + drawRect.w - rightPadding;
            const bottom = drawRect.y + drawRect.h - bottomPadding;

            let top = drawRect.y + Math.max(basePadding * 0.45, drawRect.h * config.topRatio);
            let rowAdvance = fontSize * lineHeight;
            let lineSnapped = false;
            let naturalLineStep = null;

            if (config.lineStepRatio) {
                naturalLineStep = drawRect.h * config.lineStepRatio;
                const sliderFactor = lineHeight / REAL_PAPER_BASE_LINEHEIGHT;
                rowAdvance = naturalLineStep * sliderFactor;

                const baselineY = drawRect.y + drawRect.h * config.topLineRatio;
                top = baselineY - getTextAscent(drawCtx, fontSize);
                lineSnapped = true;
            }

            return {
                left,
                right,
                top: Math.max(drawRect.y, top),
                bottom,
                rowAdvance,
                lineSnapped,
                naturalLineStep
            };
        }

        // é¢„åŠ è½½èƒŒæ™¯å›¾ç‰‡
        function preloadBackgroundImage(bgKey) {
            return new Promise((resolve, reject) => {
                const bgConfig = paperBackgrounds[bgKey];
                if (!bgConfig || bgConfig.type !== 'image') {
                    resolve(null);
                    return;
                }

                // å¦‚æœå·²ç¼“å­˜ï¼Œç›´æ¥è¿”å›
                if (bgImageCache[bgKey]) {
                    resolve(bgImageCache[bgKey]);
                    return;
                }

                // åŠ è½½å›¾ç‰‡
                const img = new Image();
                img.onload = () => {
                    bgImageCache[bgKey] = img;
                    resolve(img);
                };
                img.onerror = () => {
                    console.error(`Failed to load background image: ${bgConfig.src}`);
                    reject(new Error(`Failed to load ${bgConfig.src}`));
                };
                img.src = bgConfig.src;
            });
        }


        // æ›´æ–°æ»‘å—æ˜¾ç¤ºå€¼
        positionSlider.oninput = function () {
            document.getElementById('position-value').textContent = this.value + '%';
        };

        fontsizeSlider.oninput = function () {
            document.getElementById('fontsize-value').textContent = this.value + 'px';
        };

        lineheightSlider.oninput = function () {
            document.getElementById('lineheight-value').textContent = this.value;
        };

        scratchSlider.oninput = function () {
            document.getElementById('scratch-value').textContent = this.value + '%';
        };

        weightSlider.oninput = function () {
            document.getElementById('weight-value').textContent = this.value + '%';
        };

        // ç›‘å¬å‚æ•°å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°
        textInput.addEventListener('input', renderHandwriting);
        fontSelect.addEventListener('change', renderHandwriting);
        paperSelect.addEventListener('change', renderHandwriting);
        paperBgSelect.addEventListener('change', renderHandwriting);
        positionSlider.addEventListener('input', renderHandwriting);
        fontsizeSlider.addEventListener('input', renderHandwriting);
        lineheightSlider.addEventListener('input', renderHandwriting);
        scratchSlider.addEventListener('input', renderHandwriting);
        weightSlider.addEventListener('input', renderHandwriting);

        function updatePreviewMeta() {
            const paperText = paperSelect.options[paperSelect.selectedIndex]?.text || paperSelect.value;
            const fontText = fontSelect.options[fontSelect.selectedIndex]?.text || fontSelect.value;
            if (metaPaper) metaPaper.textContent = paperText.split('(')[0].trim();
            if (metaFont) metaFont.textContent = fontText;
            if (metaSize) metaSize.textContent = `${fontsizeSlider.value}px`;
        }

        // ä¸»æ¸²æŸ“å‡½æ•°
        async function renderHandwriting() {
            // è·å–å‚æ•°
            const text = textInput.value;
            const fontFamily = fontSelect.value;
            const paperType = paperSelect.value;
            const paperBg = paperBgSelect.value;
            const positionJitter = parseInt(positionSlider.value) / 100;
            const fontSize = parseInt(fontsizeSlider.value);
            const lineHeight = parseFloat(lineheightSlider.value);
            const scratchRate = parseInt(scratchSlider.value) / 100;
            const weightVariation = parseInt(weightSlider.value) / 100;
            updatePreviewMeta();

            // è·å–çº¸å¼ å®é™…å°ºå¯¸å’Œé¢„è§ˆç¼©æ”¾
            const paper = paperSizes[paperType];
            const scale = PREVIEW_BASE_WIDTH / paper.w;
            const displayWidth = Math.round(paper.w * scale);
            const displayHeight = Math.round(paper.h * scale);

            // è®¾ç½® Canvas å°ºå¯¸
            const dpr = window.devicePixelRatio || 1;
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

            // ç»˜åˆ¶çº¸å¼ èƒŒæ™¯ï¼ˆç­‰æ¯”ç¼©æ”¾ï¼‰
            let bgImage = null;
            const bgConfig = paperBackgrounds[paperBg];
            if (bgConfig && bgConfig.type === 'image') {
                try {
                    bgImage = await preloadBackgroundImage(paperBg);
                } catch (error) {
                    console.error('Background image load error:', error);
                }
            }
            const drawRect = drawPaperBackground(ctx, paperBg, displayWidth, displayHeight, bgImage);

            // è®¾ç½®æ–‡å­—æ ·å¼
            ctx.font = `${fontSize}px "${fontFamily}", cursive`;
            ctx.fillStyle = '#1e1e1e';
            ctx.textBaseline = 'top';

            const layout = getPaperTextLayout({
                drawCtx: ctx,
                paperBg,
                targetWidth: displayWidth,
                targetHeight: displayHeight,
                drawRect,
                fontSize,
                lineHeight
            });

            // æ¸²æŸ“æ–‡å­—
            const lines = text.split('\n');
            let y = layout.top;
            let reachedBottom = false;

            for (const line of lines) {
                let x = layout.left;

                for (const char of line) {
                    // è®¡ç®—å­—ç¬¦å®½åº¦
                    const metrics = ctx.measureText(char);
                    const charWidth = metrics.width + 2;

                    // æ™ºèƒ½æ¢è¡Œï¼šåœ¨å†™å­—ä¹‹å‰æ£€æŸ¥æ˜¯å¦ä¼šè¶…å‡ºè¾¹ç•Œ
                    if (x + charWidth > layout.right && x > layout.left) {
                        x = layout.left;
                        y += layout.rowAdvance;
                    }

                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºçº¸å¼ åº•éƒ¨
                    if (y + fontSize > layout.bottom) {
                        reachedBottom = true;
                        break; // åœæ­¢æ¸²æŸ“ï¼Œé¿å…è¶…å‡ºçº¸å¼ 
                    }

                    // è®¡ç®—éšæœºåç§»ï¼ˆé™åˆ¶èŒƒå›´ï¼Œé¿å…è¶…å‡ºè¾¹ç•Œï¼‰
                    const maxOffsetX = fontSize * positionJitter * 0.8; // é™åˆ¶åœ¨ 80%
                    const maxOffsetY = layout.lineSnapped
                        ? Math.min(layout.rowAdvance * 0.18, fontSize * positionJitter * 0.22)
                        : fontSize * positionJitter * 0.4;
                    const offsetX = (Math.random() - 0.5) * maxOffsetX;
                    const offsetY = (Math.random() - 0.5) * maxOffsetY;

                    // ç¡®ä¿å­—ç¬¦ä¸ä¼šè¶…å‡ºå·¦å³è¾¹ç•Œ
                    const maxX = Math.max(layout.left, layout.right - charWidth);
                    const finalX = Math.min(maxX, Math.max(layout.left, x + offsetX));
                    const finalY = y + offsetY;

                    // å­—ä½“ç²—ç»†å˜åŒ–ï¼ˆé€šè¿‡å¤šæ¬¡ç»˜åˆ¶æ¨¡æ‹Ÿï¼‰
                    const shouldVaryWeight = Math.random() < weightVariation;
                    if (shouldVaryWeight) {
                        // éšæœºå¢åŠ ç²—ç»†ï¼ˆç»˜åˆ¶å¤šæ¬¡ï¼Œç¨å¾®åç§»ï¼‰
                        const extraWeight = Math.floor(Math.random() * 3);
                        for (let i = 0; i < extraWeight; i++) {
                            const microOffset = i * 0.5;
                            ctx.fillText(char, finalX + microOffset, finalY);
                        }
                    }

                    // ç»˜åˆ¶å­—ç¬¦
                    ctx.fillText(char, finalX, finalY);

                    // éšæœºæ¶‚æ”¹æ•ˆæœï¼ˆåˆ é™¤çº¿ï¼‰
                    const shouldScratch = Math.random() < scratchRate;
                    if (shouldScratch) {
                        drawScratchLine(finalX, finalY, fontSize);
                    }

                    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå­—ç¬¦ä½ç½®
                    x += charWidth;
                }

                if (reachedBottom) {
                    break;
                }

                // æ¢è¡Œ
                y += layout.rowAdvance;

                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºçº¸å¼ åº•éƒ¨
                if (y > layout.bottom) {
                    break;
                }
            }
        }

        // ç»˜åˆ¶æ¶‚æ”¹æ•ˆæœï¼ˆçœŸå®æ‰‹å†™é£æ ¼ï¼‰
        function drawScratchLine(x, y, fontSize) {
            ctx.save();
            ctx.strokeStyle = '#1e1e1e';
            ctx.fillStyle = '#1e1e1e';

            const scratchType = Math.random();
            const charW = fontSize * 0.9;
            const charH = fontSize * 0.85;

            if (scratchType < 0.6) {
                // å¯†é›†æ¨ªçº¿æ¶‚æ”¹ï¼ˆæœ€å¸¸è§ï¼‰ï¼š4-6æ¡æ¥å›æ¨ªçº¿è¦†ç›–æ–‡å­—
                ctx.lineWidth = 1.2;
                ctx.globalAlpha = 0.7;
                const lineCount = 4 + Math.floor(Math.random() * 3);
                for (let i = 0; i < lineCount; i++) {
                    const lineY = y + (charH * 0.15) + (charH * 0.7 / lineCount) * i;
                    const jitterY = (Math.random() - 0.5) * 2;
                    ctx.beginPath();
                    ctx.moveTo(x - 2, lineY + jitterY);
                    // æ·»åŠ ä¸­é—´æŠ–åŠ¨ç‚¹æ¨¡æ‹Ÿæ‰‹ç»˜
                    const midX = x + charW * 0.5;
                    const midJitter = (Math.random() - 0.5) * 3;
                    ctx.quadraticCurveTo(midX, lineY + midJitter, x + charW + 2, lineY + (Math.random() - 0.5) * 2);
                    ctx.stroke();
                }
            } else if (scratchType < 0.85) {
                // æ¶‚é»‘è¦†ç›–ï¼šç”¨åŠé€æ˜å¡«å……è¦†ç›–å­—ç¬¦åŒºåŸŸ
                ctx.globalAlpha = 0.55;
                ctx.fillRect(x - 1, y + charH * 0.05, charW + 2, charH * 0.9);
                // å†åŠ å‡ æ¡æ¨ªçº¿å¢åŠ æ¶‚æŠ¹æ„Ÿ
                ctx.globalAlpha = 0.3;
                ctx.lineWidth = 2;
                for (let i = 0; i < 3; i++) {
                    const ly = y + charH * 0.2 + (charH * 0.6 / 3) * i;
                    ctx.beginPath();
                    ctx.moveTo(x - 2, ly + (Math.random() - 0.5) * 2);
                    ctx.lineTo(x + charW + 2, ly + (Math.random() - 0.5) * 2);
                    ctx.stroke();
                }
            } else {
                // åœˆç”»æ ‡è®°ï¼šç”¨æ¤­åœ†åœˆä½é”™å­—
                ctx.lineWidth = 1.5;
                ctx.globalAlpha = 0.6;
                const cx = x + charW * 0.5;
                const cy = y + charH * 0.5;
                const rx = charW * 0.6;
                const ry = charH * 0.55;
                ctx.beginPath();
                ctx.ellipse(cx, cy, rx, ry, (Math.random() - 0.5) * 0.2, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.restore();
        }

        // ä¸‹è½½å›¾ç‰‡ï¼ˆä½¿ç”¨å®é™… 600dpi åˆ†è¾¨ç‡ï¼‰
        async function downloadImage() {
            const paperType = paperSelect.value;
            const paperBg = paperBgSelect.value;
            const paper = paperSizes[paperType];
            const text = textInput.value;
            const fontFamily = fontSelect.value;
            const positionJitter = parseInt(positionSlider.value) / 100;
            const fontSize = parseInt(fontsizeSlider.value);
            const lineHeight = parseFloat(lineheightSlider.value);
            const scratchRate = parseInt(scratchSlider.value) / 100;
            const weightVariation = parseInt(weightSlider.value) / 100;

            // åˆ›å»ºé«˜æ¸… Canvas
            const exportCanvas = document.createElement('canvas');
            const exportCtx = exportCanvas.getContext('2d');
            exportCanvas.width = paper.w;
            exportCanvas.height = paper.h;

            // ç¼©æ”¾æ¯”ä¾‹ï¼ˆä»é¢„è§ˆå°ºå¯¸åˆ°å®é™…å°ºå¯¸ï¼‰
            const exportScale = paper.w / PREVIEW_BASE_WIDTH;

            // ç»˜åˆ¶çº¸å¼ èƒŒæ™¯ï¼ˆç­‰æ¯”ç¼©æ”¾ï¼‰
            let bgImage = null;
            const bgConfig = paperBackgrounds[paperBg];
            if (bgConfig && bgConfig.type === 'image') {
                try {
                    bgImage = await preloadBackgroundImage(paperBg);
                } catch (error) {
                    console.error('Background image load error:', error);
                }
            }
            const drawRect = drawPaperBackground(exportCtx, paperBg, paper.w, paper.h, bgImage);

            // è®¾ç½®æ–‡å­—æ ·å¼
            const exportFontSize = fontSize * exportScale;
            exportCtx.font = `${exportFontSize}px "${fontFamily}"`;
            exportCtx.fillStyle = '#1e1e1e';
            exportCtx.textBaseline = 'top';

            const layout = getPaperTextLayout({
                drawCtx: exportCtx,
                paperBg,
                targetWidth: paper.w,
                targetHeight: paper.h,
                drawRect,
                fontSize: exportFontSize,
                lineHeight
            });

            // æ¸²æŸ“æ–‡å­—
            const lines = text.split('\n');
            let y = layout.top;
            let reachedBottom = false;

            // ä¿å­˜ç»˜å›¾çŠ¶æ€
            exportCtx.save();

            for (const line of lines) {
                let x = layout.left;

                for (const char of line) {
                    // è®¡ç®—å­—ç¬¦å®½åº¦
                    const metrics = exportCtx.measureText(char);
                    const charWidth = metrics.width + 2 * exportScale;

                    // æ™ºèƒ½æ¢è¡Œï¼šåœ¨å†™å­—ä¹‹å‰æ£€æŸ¥æ˜¯å¦ä¼šè¶…å‡ºè¾¹ç•Œ
                    if (x + charWidth > layout.right && x > layout.left) {
                        x = layout.left;
                        y += layout.rowAdvance;
                    }

                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºçº¸å¼ åº•éƒ¨
                    if (y + exportFontSize > layout.bottom) {
                        reachedBottom = true;
                        break;
                    }

                    // è®¡ç®—éšæœºåç§»ï¼ˆé™åˆ¶èŒƒå›´ï¼‰
                    const maxOffsetX = exportFontSize * positionJitter * 0.8;
                    const maxOffsetY = layout.lineSnapped
                        ? Math.min(layout.rowAdvance * 0.18, exportFontSize * positionJitter * 0.22)
                        : exportFontSize * positionJitter * 0.4;
                    const offsetX = (Math.random() - 0.5) * maxOffsetX;
                    const offsetY = (Math.random() - 0.5) * maxOffsetY;

                    // ç¡®ä¿å­—ç¬¦ä¸ä¼šè¶…å‡ºå·¦å³è¾¹ç•Œ
                    const maxX = Math.max(layout.left, layout.right - charWidth);
                    const finalX = Math.min(maxX, Math.max(layout.left, x + offsetX));
                    const finalY = y + offsetY;

                    // å­—ä½“ç²—ç»†å˜åŒ–
                    const shouldVaryWeight = Math.random() < weightVariation;
                    if (shouldVaryWeight) {
                        const extraWeight = Math.floor(Math.random() * 3);
                        for (let i = 0; i < extraWeight; i++) {
                            const microOffset = i * 0.5 * exportScale;
                            exportCtx.fillText(char, finalX + microOffset, finalY);
                        }
                    }

                    // ç»˜åˆ¶å­—ç¬¦
                    exportCtx.fillText(char, finalX, finalY);

                    // éšæœºæ¶‚æ”¹æ•ˆæœ
                    const shouldScratch = Math.random() < scratchRate;
                    if (shouldScratch) {
                        // ç»˜åˆ¶æ¶‚æ”¹çº¿ï¼ˆç®€åŒ–ç‰ˆï¼‰
                        exportCtx.save();
                        exportCtx.strokeStyle = '#1e1e1e';
                        exportCtx.lineWidth = 2 * exportScale;
                        exportCtx.globalAlpha = 0.6;

                        const scratchType = Math.random();
                        if (scratchType < 0.7) {
                            // æ¨ªçº¿åˆ é™¤
                            exportCtx.beginPath();
                            const lineY = finalY + exportFontSize * 0.5;
                            exportCtx.moveTo(finalX - 2 * exportScale, lineY);
                            exportCtx.lineTo(finalX + charWidth + 2 * exportScale, lineY);
                            exportCtx.stroke();
                        }

                        exportCtx.restore();
                    }

                    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå­—ç¬¦ä½ç½®
                    x += charWidth;
                }

                if (reachedBottom) {
                    break;
                }

                // æ¢è¡Œ
                y += layout.rowAdvance;

                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºçº¸å¼ åº•éƒ¨
                if (y > layout.bottom) {
                    break;
                }
            }

            exportCtx.restore();

            // ä¸‹è½½
            const link = document.createElement('a');
            link.download = 'handwriting-' + paperType + '-' + Date.now() + '.png';
            link.href = exportCanvas.toDataURL('image/png');
            link.click();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¸²æŸ“
        window.onload = function () {
            // ä» URL hash è¯»å–è‡ªå®šä¹‰æ–‡æœ¬
            const hash = window.location.hash;
            if (hash && hash.startsWith('#text=')) {
                const text = decodeURIComponent(hash.substring(6));
                textInput.value = text;
            }
            renderHandwriting();
        };
    </script>
</body>

</html>
